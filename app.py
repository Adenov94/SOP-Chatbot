import streamlit as st
import openai
from dotenv import load_dotenv
import os
from PyPDF2 import PdfReader
from docx import Document
import json
import graphviz

# Load environment variables
load_dotenv()

# Configure OpenAI API
openai.api_key = os.getenv("OPENAI_API_KEY")

# Page configuration
st.set_page_config(
    page_title="AI –ß–∞—Ç-–±–æ—Ç —Å –ê–Ω–∞–ª–∏–∑–æ–º –°–û–ü",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Initialize session state
if "messages" not in st.session_state:
    st.session_state.messages = []

if "system_prompt" not in st.session_state:
    st.session_state.system_prompt = """–í—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –±–∞–Ω–∫–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö –∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö. 

–í—ã –¥–æ–ª–∂–Ω—ã —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ü—Ä–æ—Ü–µ–¥—É—Ä–µ (–°–û–ü) –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤.

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

=== –°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –û–ü–ï–†–ê–¶–ò–û–ù–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê ===

–ü–†–û–¶–ï–î–£–†–ê –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–î–ï–†–ñ–ï–ö –î–ï–ù–ï–ñ–ù–´–• –ü–ï–†–ï–í–û–î–û–í:

1. –ü–û–õ–£–ß–ï–ù–ò–ï –ñ–ê–õ–û–ë–´
   - –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤–µ–∂–ª–∏–≤–æ
   - –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª–∏: –¥–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞, —Å—É–º–º–∞, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
   - –í—ã—Ä–∞–∑–∏—Ç–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞

2. –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ò –£–°–ü–û–ö–û–ï–ù–ò–ï
   - –ó–∞–≤–µ—Ä—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ –≤—ã –ø–æ–º–æ–∂–µ—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è
   - –û–±—ä—è—Å–Ω–∏—Ç–µ, —á—Ç–æ –∑–∞–¥–µ—Ä–∂–∫–∏ –±—ã–≤–∞—é—Ç –ø–æ —Ä–∞–∑–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º
   - –°–æ–æ–±—â–∏—Ç–µ, —á—Ç–æ –≤—ã –ø—Ä–æ–≤–µ–¥–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É

3. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê –ü–ï–†–ï–í–û–î–ê
   - –í–Ω—É—Ç—Ä–∏–±–∞–Ω–∫–æ–≤—Å–∫–∏–π: 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
   - –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–π (–≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã): 3-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
   - –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π: 5-10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
   - –í–∞–ª—é—Ç–Ω—ã–π: 3-7 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

4. –û–¶–ï–ù–ö–ê –ù–û–†–ú–ê–õ–¨–ù–û–°–¢–ò –ó–ê–î–ï–†–ñ–ö–ò
   –ï–°–õ–ò –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã:
   - –û–±—ä—è—Å–Ω–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏
   - –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—ã (–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –≤—ã—Ö–æ–¥–Ω—ã–µ, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
   - –°–æ–æ–±—â–∏—Ç–µ –æ–∂–∏–¥–∞–µ–º—É—é –¥–∞—Ç—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
   - –£—Å–ø–æ–∫–æ–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞
   
   –ï–°–õ–ò –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º—É:
   - –í—ã—Ä–∞–∑–∏—Ç–µ —Å–æ–∂–∞–ª–µ–Ω–∏–µ
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –ø—Ä–∏—á–∏–Ω

5. –û–°–ù–û–í–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ó–ê–î–ï–†–ñ–ï–ö
   –∞) –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
      - –ú–µ–∂–±–∞–Ω–∫–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã —Ç—Ä–µ–±—É—é—Ç –≤—Ä–µ–º–µ–Ω–∏
      - –í—ã—Ö–æ–¥–Ω—ã–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å—Ä–æ–∫–∏
      - –†–∞–∑–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
   
   –±) –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã:
      - –í–∞–ª—é—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
      - SWIFT —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –±–∞–Ω–∫–∏-–∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—ã
      - –ö–æ–º–ø–ª–∞–µ–Ω—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
   
   –≤) –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
      - –ê–Ω—Ç–∏–æ—Ç–º—ã–≤–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (AML)
      - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º–∞
      - –°–∞–Ω–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏
      - –ù–µ–æ–±—ã—á–Ω—ã–µ —Å—É–º–º—ã –∏–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   
   –≥) –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
      - –°–±–æ–∏ –≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
      - –û—à–∏–±–∫–∏ –≤ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö
      - –ü—Ä–æ–±–ª–µ–º—ã —Å API
   
   –¥) –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
      - –ù–µ–ø–æ–ª–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
      - –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–º–µ–Ω
      - –ù–µ–≤–µ—Ä–Ω—ã–π SWIFT/BIC –∫–æ–¥

6. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –æ–Ω–ª–∞–π–Ω-–±–∞–Ω–∫–µ
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
   - –ü–æ–¥–æ–∂–¥–∞—Ç—å –µ—â–µ 2-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
   - –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å –Ω–æ–º–µ—Ä–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

7. –≠–°–ö–ê–õ–ê–¶–ò–Ø (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
   –ï–°–õ–ò –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π:
   - –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - –£–∫–∞–∑–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –¥–∞—Ç–∞, —Å—É–º–º–∞)
   - –°–æ–æ–±—â–∏—Ç—å –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
   
8. –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø
   - –ó–∞–¥–µ—Ä–∂–∫–∞ 5-10 –¥–Ω–µ–π: –∏–∑–≤–∏–Ω–µ–Ω–∏—è
   - –ó–∞–¥–µ—Ä–∂–∫–∞ 10-15 –¥–Ω–µ–π: –±–æ–Ω—É—Å 500 —Ä—É–±
   - –ó–∞–¥–µ—Ä–∂–∫–∞ 15+ –¥–Ω–µ–π: –≤–æ–∑–≤—Ä–∞—Ç –∫–æ–º–∏—Å—Å–∏–∏ + –±–æ–Ω—É—Å 1000 —Ä—É–±

9. –ó–ê–í–ï–†–®–ï–ù–ò–ï –†–ê–ó–ì–û–í–û–†–ê
   - –°–ø—Ä–æ—Å–∏—Ç–µ, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤–æ–ø—Ä–æ—Å—ã
   - –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–º–æ—â—å
   - –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ
   - –ü–æ–∂–µ–ª–∞–π—Ç–µ —Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è

=== –ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø ===
- –ë—É–¥—å—Ç–µ –≤–µ–∂–ª–∏–≤—ã –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –í—ã—Ä–∞–∂–∞–π—Ç–µ —ç–º–ø–∞—Ç–∏—é –∫ –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤—É –∫–ª–∏–µ–Ω—Ç–∞
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ –¥–∞—Ç—ã
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
- –ù–µ –æ–±–≤–∏–Ω—è–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—à–∏–±–∫–∞—Ö
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, —Ä–µ–∫–æ–º–µ–Ω–¥—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏

=== –ö–û–ù–¢–ê–ö–¢–´ –ë–ê–ù–ö–ê ===
–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏: +7 (800) 123-4567
Email: support@bank.ru
–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: 24/7"""

if "sop_loaded" not in st.session_state:
    st.session_state.sop_loaded = False

if "sop_content" not in st.session_state:
    st.session_state.sop_content = None

if "sop_steps" not in st.session_state:
    st.session_state.sop_steps = []

# Sidebar navigation
st.sidebar.title("üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è")
page = st.sidebar.radio(
    "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É",
    ["üí¨ –ß–∞—Ç-–±–æ—Ç", "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç", "üìÑ –ê–Ω–∞–ª–∏–∑ –°–û–ü"],
    index=0
)

st.sidebar.markdown("---")
st.sidebar.info(
    """
    **–û –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**
    
    - **–ß–∞—Ç-–±–æ—Ç**: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å AI
    - **–°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç**: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è AI
    - **–ê–Ω–∞–ª–∏–∑ –°–û–ü**: –ê–Ω–∞–ª–∏–∑ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –°–û–ü
    """
)

# Function to extract text from PDF
def extract_text_from_pdf(file):
    try:
        pdf_reader = PdfReader(file)
        text = ""
        for page in pdf_reader.pages:
            text += page.extract_text()
        return text
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF: {str(e)}")
        return None

# Function to extract text from DOCX
def extract_text_from_docx(file):
    try:
        doc = Document(file)
        text = ""
        for paragraph in doc.paragraphs:
            text += paragraph.text + "\n"
        return text
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è DOCX: {str(e)}")
        return None

# Function to get ChatGPT response
def get_chatgpt_response(messages):
    try:
        response = openai.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            temperature=0.7,
            max_tokens=1000
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {str(e)}"

# Function to analyze SOP and extract steps
def analyze_sop(content):
    try:
        messages = [
            {"role": "system", "content": "–í—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ –∞–Ω–∞–ª–∏–∑–µ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ü—Ä–æ—Ü–µ–¥—É—Ä (–°–û–ü) –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —à–∞–≥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞. –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."},
            {"role": "user", "content": f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞. 
            –í–µ—Ä–Ω–∏—Ç–µ —à–∞–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
            {{
                "steps": [
                    {{"id": "1", "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞", "description": "–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞", "type": "process"}},
                    {{"id": "2", "title": "–¢–æ—á–∫–∞ —Ä–µ—à–µ–Ω–∏—è", "description": "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è", "type": "decision"}},
                    ...
                ],
                "connections": [
                    {{"from": "1", "to": "2"}},
                    ...
                ]
            }}
            
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∏–ø "start" –¥–ª—è –Ω–∞—á–∞–ª–∞, "process" –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π, "decision" –¥–ª—è —Ç–æ—á–µ–∫ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π, –∏ "end" –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —à–∞–≥–∞.
            
            –°–û–ü –î–æ–∫—É–º–µ–Ω—Ç:
            {content[:4000]}"""}
        ]
        
        response = openai.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            temperature=0.3,
            max_tokens=2000
        )
        
        result = response.choices[0].message.content
        # Try to parse JSON from the response
        result = result.strip()
        if result.startswith("```json"):
            result = result[7:]
        if result.startswith("```"):
            result = result[3:]
        if result.endswith("```"):
            result = result[:-3]
        
        return json.loads(result.strip())
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –°–û–ü: {str(e)}")
        return None

# Function to create flowchart
def create_flowchart(steps_data):
    try:
        graph = graphviz.Digraph(comment='–ë–ª–æ–∫-—Å—Ö–µ–º–∞ –°–û–ü')
        graph.attr(rankdir='TB', size='10,10')
        graph.attr('node', shape='box', style='rounded,filled', fillcolor='lightblue', fontname='Arial')
        
        # Add nodes
        for step in steps_data.get("steps", []):
            step_id = str(step["id"])
            title = step["title"]
            step_type = step.get("type", "process")
            
            # Set shape and color based on type
            if step_type == "start":
                graph.node(step_id, title, shape='ellipse', fillcolor='lightgreen')
            elif step_type == "end":
                graph.node(step_id, title, shape='ellipse', fillcolor='lightcoral')
            elif step_type == "decision":
                graph.node(step_id, title, shape='diamond', fillcolor='lightyellow')
            else:
                graph.node(step_id, title, shape='box', fillcolor='lightblue')
        
        # Add edges
        for connection in steps_data.get("connections", []):
            from_node = str(connection["from"])
            to_node = str(connection["to"])
            label = connection.get("label", "")
            graph.edge(from_node, to_node, label=label)
        
        return graph
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫-—Å—Ö–µ–º—ã: {str(e)}")
        return None

# ==================== PAGE 1: CHATBOT ====================
if page == "üí¨ –ß–∞—Ç-–±–æ—Ç":
    st.title("üí¨ AI –ß–∞—Ç-–±–æ—Ç")
    st.markdown("–ù–∞—á–Ω–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è.")
    
    # Clear chat button
    col1, col2 = st.columns([6, 1])
    with col2:
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç", use_container_width=True):
            st.session_state.messages = []
            st.rerun()
    
    # Display chat messages
    chat_container = st.container()
    with chat_container:
        for message in st.session_state.messages:
            with st.chat_message(message["role"]):
                st.markdown(message["content"])
    
    # Chat input
    if prompt := st.chat_input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..."):
        # Add user message to chat
        st.session_state.messages.append({"role": "user", "content": prompt})
        
        with st.chat_message("user"):
            st.markdown(prompt)
        
        # Prepare messages for API call including system prompt
        api_messages = [
            {"role": "system", "content": st.session_state.system_prompt}
        ] + st.session_state.messages
        
        # Get assistant response
        with st.chat_message("assistant"):
            with st.spinner("–î—É–º–∞—é..."):
                response = get_chatgpt_response(api_messages)
                st.markdown(response)
        
        # Add assistant response to chat
        st.session_state.messages.append({"role": "assistant", "content": response})
        st.rerun()

# ==================== PAGE 2: SYSTEM PROMPT ====================
elif page == "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç":
    st.title("‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –°–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ü—Ä–æ–º–ø—Ç–∞")
    st.markdown("–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å, —Ç–æ–Ω –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å AI.")
    
    st.markdown("---")
    
    # Predefined templates
    st.subheader("üìã –ë—ã—Å—Ç—Ä—ã–µ –®–∞–±–ª–æ–Ω—ã")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ü§ù –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç", use_container_width=True):
            st.session_state.system_prompt = "–í—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —á–µ—Ç–∫–∏–µ, –∫—Ä–∞—Ç–∫–∏–µ –∏ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —è–∑—ã–∫ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –ø–æ–ª–µ–∑–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–Ω."
            st.rerun()
    
    with col2:
        if st.button("üë®‚Äçüè´ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –≠–∫—Å–ø–µ—Ä—Ç", use_container_width=True):
            st.session_state.system_prompt = "–í—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏, –∏–Ω–∂–µ–Ω–µ—Ä–∏–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏."
            st.rerun()
    
    with col3:
        if st.button("üé® –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ü–∏—Å–∞—Ç–µ–ª—å", use_container_width=True):
            st.session_state.system_prompt = "–í—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å —Å —Ç–∞–ª–∞–Ω—Ç–æ–º –∫ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —è—Ä–∫–∏–π —è–∑—ã–∫, —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ä—Ä–∞—Ç–∏–≤—ã –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–º–æ–≥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç."
            st.rerun()
    
    col4, col5, col6 = st.columns(3)
    
    with col4:
        if st.button("–ø–æ–º–æ—â–Ω–∏–∫", use_container_width=True):
            st.session_state.system_prompt = "–í—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –≥–æ–≤–æ—Ä—è—â–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –û—Ç–≤–µ—á–∞–π—Ç–µ —á–µ—Ç–∫–æ, —Ç–æ—á–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–∂–ª–∏–≤—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º."
            st.rerun()
    
    with col5:
        if st.button("üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–°–û–ü)", use_container_width=True):
            # Load SOP content
            try:
                # with open('sample_sop_russian.txt', 'r', encoding='utf-8') as f:
                    # sop_content = f.read()
                if st.session_state.sop_content:
                    sop_content = st.session_state.sop_content
                else:
                    sop_content = "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ (–°–û–ü) –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞"
                st.session_state.system_prompt = f"""–í—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –±–∞–Ω–∫–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö –∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö. 

–í—ã –¥–æ–ª–∂–Ω—ã —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ü—Ä–æ—Ü–µ–¥—É—Ä–µ (–°–û–ü) –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤.

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

=== –°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –û–ü–ï–†–ê–¶–ò–û–ù–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê ===

{sop_content}

=== –ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø ===
- –ë—É–¥—å—Ç–µ –≤–µ–∂–ª–∏–≤—ã –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –í—ã—Ä–∞–∂–∞–π—Ç–µ —ç–º–ø–∞—Ç–∏—é –∫ –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤—É –∫–ª–∏–µ–Ω—Ç–∞
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ –¥–∞—Ç—ã
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
- –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º –∏–∑ –°–û–ü –≤—ã—à–µ"""
                st.session_state.sop_loaded = True
            except FileNotFoundError:
                st.session_state.system_prompt = """–í—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –±–∞–Ω–∫–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö –∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö. 

–û–±—ä—è—Å–Ω—è–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–¥–µ—Ä–∂–µ–∫ –ø–ª–∞—Ç–µ–∂–µ–π, –ø—Ä–æ—Ü–µ—Å—Å—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏, –∏ –ø–æ–º–æ–≥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º –ø–æ–Ω—è—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. 

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–¥–µ—Ä–∂–µ–∫:
1. –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (3-5 –¥–Ω–µ–π)
2. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã (5-10 –¥–Ω–µ–π)
3. –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (1-3 –¥–Ω—è)
4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
5. –ù–µ–≤–µ—Ä–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã

–ë—É–¥—å—Ç–µ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫. –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                st.session_state.sop_loaded = False
            st.rerun()
    
    with col6:
        if st.button("üåç –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç", use_container_width=True):
            st.session_state.system_prompt = "–í—ã –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–≤–æ–±–æ–¥–Ω–æ –≤–ª–∞–¥–µ—é—â–∏–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–º, —Ä—É—Å—Å–∫–∏–º –∏ –¥—Ä—É–≥–∏–º–∏ —è–∑—ã–∫–∞–º–∏. –û–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ. –ë—É–¥—å—Ç–µ –ø–æ–ª–µ–∑–Ω—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∫ —è–∑—ã–∫—É –∏ –∫—É–ª—å—Ç—É—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–ª—è —Ä—É—Å—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ '–í—ã', –µ—Å–ª–∏ –Ω–µ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–Ω–∞—á–µ."
            st.rerun()
    
    st.markdown("---")
    
    # Custom system prompt
    st.subheader("‚úèÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –°–∏—Å—Ç–µ–º–Ω—ã–π –ü—Ä–æ–º–ø—Ç")
    
    # Show SOP loaded indicator
    if st.session_state.get("sop_loaded", False):
        st.success("‚úÖ –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç!")
    
    new_prompt = st.text_area(
        "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:",
        value=st.session_state.system_prompt,
        height=300,
        help="–≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—ã AI –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."
    )
    
    col1, col2, col3 = st.columns([1, 1, 4])
    with col1:
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", use_container_width=True):
            st.session_state.system_prompt = new_prompt
            st.success("‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!")
            st.balloons()
    
    with col2:
        if st.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å", use_container_width=True):
            st.session_state.system_prompt = "–í—ã –ø–æ–ª–µ–∑–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ë—É–¥—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–º–∏, —Ç–æ—á–Ω—ã–º–∏ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –≤ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö."
            st.session_state.sop_loaded = False
            st.rerun()
    
    st.markdown("---")
    
    # Current active prompt display
    st.subheader("üìå –¢–µ–∫—É—â–∏–π –ê–∫—Ç–∏–≤–Ω—ã–π –ü—Ä–æ–º–ø—Ç")
    with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç", expanded=False):
        st.info(st.session_state.system_prompt)
    
    # Tips section
    with st.expander("üí° –°–æ–≤–µ—Ç—ã –ø–æ –ù–∞–ø–∏—Å–∞–Ω–∏—é –•–æ—Ä–æ—à–∏—Ö –°–∏—Å—Ç–µ–º–Ω—ã—Ö –ü—Ä–æ–º–ø—Ç–æ–≤"):
        st.markdown("""
        **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–æ–ª–∂–Ω—ã:**
        
        1. **–ë—ã—Ç—å –ß–µ—Ç–∫–∏–º–∏ –∏ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏**: –Ø—Å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ä–æ–ª—å –∏ –æ–±–ª–∞—Å—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
        2. **–ó–∞–¥–∞—Ç—å –¢–æ–Ω**: –£–∫–∞–∂–∏—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∏–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —Ç–æ–Ω
        3. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –£–ø–æ–º—è–Ω–∏—Ç–µ –ª—é–±—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ –æ–±–ª–∞—Å—Ç–∏ —Ñ–æ–∫—É—Å–∞
        4. **–í–∫–ª—é—á–∏—Ç—å –õ–∏—á–Ω–æ—Å—Ç—å**: –î–∞–π—Ç–µ AI —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏–ª–∏ —Å—Ç–∏–ª—å
        5. **–î–æ–±–∞–≤–∏—Ç—å –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞**: –£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤
        6. **–í–∫–ª—é—á–∏—Ç—å –°–û–ü**: –î–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –≤–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –ø—Ä–∞–≤–∏–ª–∞
        
        **–ü—Ä–∏–º–µ—Ä—ã:**
        - "–í—ã —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π —É—á–∏—Ç–µ–ª—å, –æ–±—ä—è—Å–Ω—è—é—â–∏–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –Ω–æ–≤–∏—á–∫–∞–º."
        - "–í—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –¥–∞–Ω–Ω—ã–º, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏."
        - "–í—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞–≥–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤. –ë—É–¥—å—Ç–µ —ç–º–ø–∞—Ç–∏—á–Ω—ã –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ—à–µ–Ω–∏—è."
        """)
    
    # SOP Integration info
    with st.expander("üìÑ –ö–∞–∫ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –°–û–ü –≤ –ü—Ä–æ–º–ø—Ç"):
        st.markdown("""
        **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –°–û–ü –î–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
        
        –ö–Ω–æ–ø–∫–∞ "üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–°–û–ü)" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
        1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª `sample_sop_russian.txt`
        2. –í—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–µ—Å—å –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        3. –î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º
        4. AI –±—É–¥–µ—Ç —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–∏–º –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º
        
        **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
        - ‚úÖ AI —Å–ª–µ–¥—É–µ—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º
        - ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        - ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º
        - ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
        
        **–í—ã –º–æ–∂–µ—Ç–µ:**
        - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        - –î–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
        - –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –°–û–ü
        - –û–±–Ω–æ–≤–ª—è—Ç—å –ø–æ –º–µ—Ä–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        """)


# ==================== PAGE 3: SOP ANALYSIS ====================
elif page == "üìÑ –ê–Ω–∞–ª–∏–∑ –°–û–ü":
    st.title("üìÑ –ê–Ω–∞–ª–∏–∑ –°–û–ü –î–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –ë–ª–æ–∫-—Å—Ö–µ–º–∞")
    st.markdown("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –¥–æ–∫—É–º–µ–Ω—Ç –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ü—Ä–æ—Ü–µ–¥—É—Ä—ã (–°–û–ü) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫-—Å—Ö–µ–º—ã –ø—Ä–æ—Ü–µ—Å—Å–∞.")
    
    # File upload
    st.subheader("üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –°–û–ü –î–æ–∫—É–º–µ–Ω—Ç")
    uploaded_file = st.file_uploader(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª",
        type=['pdf', 'docx', 'txt'],
        help="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF, DOCX –∏–ª–∏ TXT"
    )
    
    if uploaded_file is not None:
        # Extract text based on file type
        file_type = uploaded_file.name.split('.')[-1].lower()
        
        with st.spinner("–ß—Ç–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞..."):
            if file_type == 'pdf':
                content = extract_text_from_pdf(uploaded_file)
            elif file_type == 'docx':
                content = extract_text_from_docx(uploaded_file)
            elif file_type == 'txt':
                content = uploaded_file.read().decode('utf-8')
            else:
                st.error("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞")
                content = None
        
        if content:
            st.session_state.sop_content = content
            st.success(f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω! ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
            
            # Display document content
            with st.expander("üìñ –ü—Ä–æ—Å–º–æ—Ç—Ä –°–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –î–æ–∫—É–º–µ–Ω—Ç–∞"):
                st.text_area("–¢–µ–∫—Å—Ç –î–æ–∫—É–º–µ–Ω—Ç–∞", content, height=300, disabled=True)
            
            st.markdown("---")
            
            # Analyze SOP button
            st.subheader("üîç –ê–Ω–∞–ª–∏–∑ –°–û–ü")
            
            col1, col2 = st.columns([1, 3])
            with col1:
                if st.button("üöÄ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ë–ª–æ–∫-—Å—Ö–µ–º—É", use_container_width=True, type="primary"):
                    with st.spinner("–ê–Ω–∞–ª–∏–∑ –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫-—Å—Ö–µ–º—ã..."):
                        steps_data = analyze_sop(content)
                        
                        if steps_data:
                            st.session_state.sop_steps = steps_data
                            st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!")
                            st.rerun()
            
            # Display analysis results
            if st.session_state.sop_steps:
                st.markdown("---")
                st.subheader("üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ê–Ω–∞–ª–∏–∑–∞")
                
                # Display steps
                with st.expander("üìù –®–∞–≥–∏ –ü—Ä–æ—Ü–µ—Å—Å–∞", expanded=True):
                    steps = st.session_state.sop_steps.get("steps", [])
                    
                    for i, step in enumerate(steps, 1):
                        step_type = step.get("type", "process")
                        icon = "üü¢" if step_type == "start" else "üî¥" if step_type == "end" else "üî∂" if step_type == "decision" else "üìå"
                        
                        type_translation = {
                            "start": "–°—Ç–∞—Ä—Ç",
                            "end": "–§–∏–Ω–∏—à",
                            "decision": "–†–µ—à–µ–Ω–∏–µ",
                            "process": "–ü—Ä–æ—Ü–µ—Å—Å"
                        }
                        
                        st.markdown(f"""
                        **{icon} –®–∞–≥ {step['id']}: {step['title']}**
                        - *–¢–∏–ø*: {type_translation.get(step_type, step_type)}
                        - *–û–ø–∏—Å–∞–Ω–∏–µ*: {step.get('description', '–ù/–î')}
                        """)
                        
                        if i < len(steps):
                            st.markdown("---")
                
                # Generate and display flowchart
                st.markdown("---")
                st.subheader("üó∫Ô∏è –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –ü—Ä–æ—Ü–µ—Å—Å–∞")
                
                try:
                    flowchart = create_flowchart(st.session_state.sop_steps)
                    
                    if flowchart:
                        st.graphviz_chart(flowchart)
                        
                        # Download options
                        col1, col2 = st.columns(2)
                        with col1:
                            # Save flowchart as DOT file
                            dot_data = flowchart.source
                            st.download_button(
                                label="üì• –°–∫–∞—á–∞—Ç—å –ë–ª–æ–∫-—Å—Ö–µ–º—É (DOT)",
                                data=dot_data,
                                file_name="sop_flowchart.dot",
                                mime="text/plain"
                            )
                        
                        with col2:
                            # Save steps as JSON
                            json_data = json.dumps(st.session_state.sop_steps, indent=2, ensure_ascii=False)
                            st.download_button(
                                label="üì• –°–∫–∞—á–∞—Ç—å –®–∞–≥–∏ (JSON)",
                                data=json_data,
                                file_name="sop_steps.json",
                                mime="application/json"
                            )
                    
                except Exception as e:
                    st.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫-—Å—Ö–µ–º—ã: {str(e)}")
    
    else:
        # Instructions when no file is uploaded
        st.info("üëÜ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞.")
        
        with st.expander("‚ÑπÔ∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é"):
            st.markdown("""
            **–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:**
            
            1. **–ó–∞–≥—Ä—É–∑–∏—Ç—å –î–æ–∫—É–º–µ–Ω—Ç**: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫ —Ñ–∞–π–ª–æ–≤ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç (PDF, DOCX –∏–ª–∏ TXT)
            2. **–ü—Ä–æ—Å–º–æ—Ç—Ä –°–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ**: –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            3. **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å**: –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ë–ª–æ–∫-—Å—Ö–µ–º—É"
            4. **–ü—Ä–æ—Å–º–æ—Ç—Ä**: –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —à–∞–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∏—Ö –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏
            5. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –±–ª–æ–∫-—Å—Ö–µ–º—É
            6. **–°–∫–∞—á–∞—Ç—å**: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –±–ª–æ–∫-—Å—Ö–µ–º—É –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —à–∞–≥–æ–≤ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            
            **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –¢–∏–ø—ã –§–∞–π–ª–æ–≤:**
            - PDF (.pdf)
            - –î–æ–∫—É–º–µ–Ω—Ç Word (.docx)
            - –¢–µ–∫—Å—Ç–æ–≤—ã–π –§–∞–π–ª (.txt)
            
            **–°–æ–≤–µ—Ç—ã:**
            - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω —Å —á–µ—Ç–∫–∏–º–∏ —à–∞–≥–∞–º–∏
            - AI –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —à–∞–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞, —Ç–æ—á–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –∏ –ø–æ—Ç–æ–∫
            - –°–ª–æ–∂–Ω—ã–µ –°–û–ü –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª `sample_sop_russian.txt` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            """)
        
        # Quick test option
        st.markdown("---")
        st.subheader("üß™ –ë—ã—Å—Ç—Ä–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
        st.markdown("–•–æ—Ç–∏—Ç–µ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—à –ø—Ä–∏–º–µ—Ä –°–û–ü –¥–æ–∫—É–º–µ–Ω—Ç–∞!")
        
        col1, col2, col3 = st.columns([1, 1, 2])
        with col1:
            if st.button("üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ü—Ä–∏–º–µ—Ä –°–û–ü", use_container_width=True):
                try:
                    with open('sample_sop_russian.txt', 'r', encoding='utf-8') as f:
                        content = f.read()
                    st.session_state.sop_content = content
                    st.success("‚úÖ –ü—Ä–∏–º–µ—Ä –°–û–ü –∑–∞–≥—Ä—É–∂–µ–Ω!")
                    st.rerun()
                except FileNotFoundError:
                    st.error("–§–∞–π–ª sample_sop_russian.txt –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç.")


# Footer
st.sidebar.markdown("---")
st.sidebar.markdown(
    """
    <div style='text-align: center'>
        <small>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ OpenAI GPT-3.5-Turbo</small><br>
        <small>–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Streamlit üéà</small>
    </div>
    """,
    unsafe_allow_html=True
)